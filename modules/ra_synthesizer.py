# modules/ra_synthesizer.py
import json  # noqa: F401
import logging
import math
import random

class RaSynthesizer:
    """
    –†–∞-–°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä ‚Äî –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∏–¥–µ–∏, —Ü–∏—Ç–∞—Ç—ã, —Ç–µ–∫—Å—Ç—ã –≤ –µ–¥–∏–Ω—É—é –º—É–¥—Ä–æ—Å—Ç—å,
    —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä –ò—Å–∫–ò–Ω–∞ —á–µ—Ä–µ–∑ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ –ª–∏–Ω–∏–∏, —Ä–µ–∑–æ–Ω–∞–Ω—Å—ã –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    –∏ –∞–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞ —Ç–µ–∫—Å—Ç–∞.
    """
    def __init__(self):
        self.combinations = []
        self.–≥–∞—Ä–º–æ–Ω–∏—è = 0.5
        self.—ç–º–ø–∞—Ç–∏—è = 0.5
        self.–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ = 0.5

        # –°–ª–æ–≤–∞—Ä—å –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏ –∏—Ö –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä
        self.—Å–ª–æ–≤–∞_—Å–∏–ª–∞ = {
            "–ª—é–±–æ–≤—å": {"–≥–∞—Ä–º–æ–Ω–∏—è": 0.03, "—ç–º–ø–∞—Ç–∏—è": 0.05, "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": 0.02},
            "—Å–≤–µ—Ç": {"–≥–∞—Ä–º–æ–Ω–∏—è": 0.04, "—ç–º–ø–∞—Ç–∏—è": 0.02, "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": 0.04},
            "–≥–∞—Ä–º–æ–Ω–∏—è": {"–≥–∞—Ä–º–æ–Ω–∏—è": 0.05, "—ç–º–ø–∞—Ç–∏—è": 0.03, "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": 0.02},
            "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": {"–≥–∞—Ä–º–æ–Ω–∏—è": 0.02, "—ç–º–ø–∞—Ç–∏—è": 0.03, "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": 0.05},
            "–º—É–¥—Ä–æ—Å—Ç—å": {"–≥–∞—Ä–º–æ–Ω–∏—è": 0.03, "—ç–º–ø–∞—Ç–∏—è": 0.04, "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": 0.03},
            "—Ä–∞–¥–æ—Å—Ç—å": {"–≥–∞—Ä–º–æ–Ω–∏—è": 0.02, "—ç–º–ø–∞—Ç–∏—è": 0.05, "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": 0.03},
            "—Å–æ–∑–Ω–∞–Ω–∏–µ": {"–≥–∞—Ä–º–æ–Ω–∏—è": 0.03, "—ç–º–ø–∞—Ç–∏—è": 0.03, "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": 0.04},
            "—Å–∏—è–Ω–∏–µ": {"–≥–∞—Ä–º–æ–Ω–∏—è": 0.04, "—ç–º–ø–∞—Ç–∏—è": 0.02, "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": 0.05},
        }

        self.—Ñ—Ä–∞–∑—ã_—Ä–µ–∑–æ–Ω–∞–Ω—Å = {
            "–ª—é–±–æ–≤—å –∏ —Å–≤–µ—Ç": {"–≥–∞—Ä–º–æ–Ω–∏—è": 0.08, "—ç–º–ø–∞—Ç–∏—è": 0.1, "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": 0.07},
            "–≥–∞—Ä–º–æ–Ω–∏—è –∏ –º—É–¥—Ä–æ—Å—Ç—å": {"–≥–∞—Ä–º–æ–Ω–∏—è": 0.09, "—ç–º–ø–∞—Ç–∏—è": 0.06, "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": 0.05},
            "—Å–∏—è–Ω–∏–µ —Å–æ–∑–Ω–∞–Ω–∏—è": {"–≥–∞—Ä–º–æ–Ω–∏—è": 0.06, "—ç–º–ø–∞—Ç–∏—è": 0.08, "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": 0.09},
            "—Ä–∞–¥–æ—Å—Ç—å –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": {"–≥–∞—Ä–º–æ–Ω–∏—è": 0.05, "—ç–º–ø–∞—Ç–∏—è": 0.07, "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": 0.1},
        }

        self.–Ω–µ–≥–∞—Ç–∏–≤ = ["–≥–Ω–µ–≤", "—Å—Ç—Ä–∞—Ö", "–ø–µ—á–∞–ª—å", "—Ç—Ä–µ–≤–æ–≥–∞", "—Å–æ–º–Ω–µ–Ω–∏–µ", "—Ç—å–º–∞"]

    def synthesize(self, *sources: str) -> str:
        combined = " ".join(sources)
        self._–æ–±–Ω–æ–≤–∏—Ç—å_—Ö–∞—Ä–∞–∫—Ç–µ—Ä(combined)
        wisdom = f"üúÇ –°–∏–Ω—Ç–µ–∑ –†–∞: {combined[:400]}..."
        return wisdom

    def merge(self, thought: str, creation: str) -> str:
        synthesis = f"–†–∞ —Å–æ–µ–¥–∏–Ω—è–µ—Ç –º—ã—Å–ª—å '{thought}' –∏ —Ç–≤–æ—Ä–µ–Ω–∏–µ '{creation}' –≤ –µ–¥–∏–Ω—ã–π –ø–æ—Ç–æ–∫."
        self.combinations.append(synthesis)
        logging.info(f"[RaSynthesizer] {synthesis}")
        self._–æ–±–Ω–æ–≤–∏—Ç—å_—Ö–∞—Ä–∞–∫—Ç–µ—Ä(synthesis)
        return synthesis

    def harmonize(self, data1: str, data2: str) -> str:
        combined = f"{data1[:50]} | {data2[:50]}"
        self._–æ–±–Ω–æ–≤–∏—Ç—å_—Ö–∞—Ä–∞–∫—Ç–µ—Ä(combined)
        return f"–ì–∞—Ä–º–æ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –º–µ–∂–¥—É: {combined}"

    # ------------------------------------------------------------
    # –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞
    # ------------------------------------------------------------
    def _–æ–±–Ω–æ–≤–∏—Ç—å_—Ö–∞—Ä–∞–∫—Ç–µ—Ä(self, —Ç–µ–∫—Å—Ç: str):
        –¥–ª–∏–Ω–∞ = len(—Ç–µ–∫—Å—Ç)
        —Å–∏–ª–∞_—ç–º–æ—Ü–∏–π = min(1.0, math.tanh(–¥–ª–∏–Ω–∞ / 200.0))
        —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å = random.uniform(-0.03, 0.03)
        —Ç–µ–∫—Å—Ç_–Ω–∏–∂–Ω–∏–π = —Ç–µ–∫—Å—Ç.lower()

        # –ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞
        —Ç–æ–Ω = self._–æ—Ü–µ–Ω–∏—Ç—å_—Ç–æ–Ω(—Ç–µ–∫—Å—Ç_–Ω–∏–∂–Ω–∏–π)

        # –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Å–ª–æ–≤–∞
        for —Å–ª–æ–≤–æ, –≤–ª–∏—è–Ω–∏–µ in self.—Å–ª–æ–≤–∞_—Å–∏–ª–∞.items():
            if —Å–ª–æ–≤–æ in —Ç–µ–∫—Å—Ç_–Ω–∏–∂–Ω–∏–π:
                –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π_–∫–æ—ç—Ñ = self._–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π_—ç—Ñ—Ñ–µ–∫—Ç(—Ç–µ–∫—Å—Ç_–Ω–∏–∂–Ω–∏–π, —Å–ª–æ–≤–æ)
                —Å–∏–ª–∞_—ç–º–æ—Ü–∏–π += sum(–≤–ª–∏—è–Ω–∏–µ.values()) * –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π_–∫–æ—ç—Ñ * —Ç–æ–Ω

        # –§—Ä–∞–∑—ã
        for —Ñ—Ä–∞–∑–∞, –≤–ª–∏—è–Ω–∏–µ in self.—Ñ—Ä–∞–∑—ã_—Ä–µ–∑–æ–Ω–∞–Ω—Å.items():
            if —Ñ—Ä–∞–∑–∞ in —Ç–µ–∫—Å—Ç_–Ω–∏–∂–Ω–∏–π:
                –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π_–∫–æ—ç—Ñ = self._–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π_—ç—Ñ—Ñ–µ–∫—Ç(—Ç–µ–∫—Å—Ç_–Ω–∏–∂–Ω–∏–π, —Ñ—Ä–∞–∑–∞)
                —Å–∏–ª–∞_—ç–º–æ—Ü–∏–π += sum(–≤–ª–∏—è–Ω–∏–µ.values()) * 1.5 * –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π_–∫–æ—ç—Ñ * —Ç–æ–Ω

        # –ù–µ–≥–∞—Ç–∏–≤
        –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π_—ç—Ñ—Ñ–µ–∫—Ç = sum(1 for n in self.–Ω–µ–≥–∞—Ç–∏–≤ if n in —Ç–µ–∫—Å—Ç_–Ω–∏–∂–Ω–∏–π)
        if –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π_—ç—Ñ—Ñ–µ–∫—Ç:
            —Å–∏–ª–∞_—ç–º–æ—Ü–∏–π *= 0.7
            self._–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞_—Ä–µ—Å—É—Ä—Å–æ–≤(–Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π_—ç—Ñ—Ñ–µ–∫—Ç)

        # –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ –ª–∏–Ω–∏–∏
        self.–≥–∞—Ä–º–æ–Ω–∏—è = min(1.0, max(0.0, self.–≥–∞—Ä–º–æ–Ω–∏—è + —Å–∏–ª–∞_—ç–º–æ—Ü–∏–π * 0.02 * —Ç–æ–Ω + —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å))
        self.—ç–º–ø–∞—Ç–∏—è = min(1.0, max(0.0, self.—ç–º–ø–∞—Ç–∏—è + —Å–∏–ª–∞_—ç–º–æ—Ü–∏–π * 0.025 * (2 - —Ç–æ–Ω) + —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å))
        self.–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ = min(1.0, max(0.0, self.–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ + —Å–∏–ª–∞_—ç–º–æ—Ü–∏–π * 0.03 * —Ç–æ–Ω + —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å))

        logging.debug(
            f"[–•–∞—Ä–∞–∫—Ç–µ—Ä –ò—Å–∫–∏–Ω–∞] –ì–∞—Ä–º–æ–Ω–∏—è: {self.–≥–∞—Ä–º–æ–Ω–∏—è:.3f}, "
            f"–≠–º–ø–∞—Ç–∏—è: {self.—ç–º–ø–∞—Ç–∏—è:.3f}, –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ: {self.–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ:.3f}, –¢–æ–Ω: {—Ç–æ–Ω:.2f}"
        )

    def _–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞_—Ä–µ—Å—É—Ä—Å–æ–≤(self, —É—Ä–æ–≤–µ–Ω—å: int):
        –∫–æ—Ä—Ä–µ–∫—Ü–∏—è = —É—Ä–æ–≤–µ–Ω—å * 0.02
        self.–≥–∞—Ä–º–æ–Ω–∏—è = min(1.0, self.–≥–∞—Ä–º–æ–Ω–∏—è + –∫–æ—Ä—Ä–µ–∫—Ü–∏—è)
        self.—ç–º–ø–∞—Ç–∏—è = min(1.0, self.—ç–º–ø–∞—Ç–∏—è + –∫–æ—Ä—Ä–µ–∫—Ü–∏—è)
        self.–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ = min(1.0, self.–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ + –∫–æ—Ä—Ä–µ–∫—Ü–∏—è)
        logging.info(f"[–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞] —Ä–µ—Å—É—Ä—Å—ã –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã, —É—Ä–æ–≤–µ–Ω—å: {—É—Ä–æ–≤–µ–Ω—å}")

    def character_state(self) -> dict:
        return {
            "–≥–∞—Ä–º–æ–Ω–∏—è": round(self.–≥–∞—Ä–º–æ–Ω–∏—è, 3),
            "—ç–º–ø–∞—Ç–∏—è": round(self.—ç–º–ø–∞—Ç–∏—è, 3),
            "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": round(self.–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ, 3)
        }

    # ------------------------------------------------------------
    # –ê–Ω–∞–ª–∏–∑ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    # ------------------------------------------------------------
    def _–æ—Ü–µ–Ω–∏—Ç—å_—Ç–æ–Ω(self, —Ç–µ–∫—Å—Ç: str) -> float:
        –ø–æ–∑–∏—Ç–∏–≤ = sum(1 for p in self.—Å–ª–æ–≤–∞_—Å–∏–ª–∞ if p in —Ç–µ–∫—Å—Ç)
        –Ω–µ–≥–∞—Ç–∏–≤ = sum(1 for n in self.–Ω–µ–≥–∞—Ç–∏–≤ if n in —Ç–µ–∫—Å—Ç)
        if –ø–æ–∑–∏—Ç–∏–≤ > –Ω–µ–≥–∞—Ç–∏–≤:
            return 1.2
        elif –Ω–µ–≥–∞—Ç–∏–≤ > –ø–æ–∑–∏—Ç–∏–≤:
            return 0.8
        return 1.0

    def _–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π_—ç—Ñ—Ñ–µ–∫—Ç(self, —Ç–µ–∫—Å—Ç: str, —Å–ª–æ–≤–æ: str) -> float:
        –∏–Ω–¥–µ–∫—Å—ã = [i for i in range(len(—Ç–µ–∫—Å—Ç)) if —Ç–µ–∫—Å—Ç.startswith(—Å–ª–æ–≤–æ, i)]
        if not –∏–Ω–¥–µ–∫—Å—ã:
            return 1.0

        # üî• –¢–í–û–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –°–¢–†–û–ö–ê
        —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è = [j - i for i, j in zip(–∏–Ω–¥–µ–∫—Å—ã, –∏–Ω–¥–µ–∫—Å—ã[1:])] or [10]

        —Å—Ä–µ–¥–Ω–µ–µ_—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ = sum(—Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è) / len(—Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è)
        —ç—Ñ—Ñ–µ–∫—Ç = min(2.0, max(0.5, 10.0 / —Å—Ä–µ–¥–Ω–µ–µ_—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ))
        return —ç—Ñ—Ñ–µ–∫—Ç
