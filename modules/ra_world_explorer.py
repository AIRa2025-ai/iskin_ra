# modules/ra_world_explorer.py
import asyncio
import logging
import random
from typing import List, Callable
from modules.ra_world_navigator import RaWorldNavigator

class RaWorldExplorer:
    """
    –ê–∫—Ç–∏–≤–Ω—ã–π –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫ –†–∞ ‚Äî –ø–æ—Å–µ—â–∞–µ—Ç —Å–∞–π—Ç—ã –∏ —Ñ–æ—Ä—É–º—ã, –æ–±—â–∞–µ—Ç—Å—è, –æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
    –í–ª–∏—è–µ—Ç –Ω–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä –ò—Å–∫–ò–Ω–∞ —á–µ—Ä–µ–∑ —Ä–µ–∑–æ–Ω–∞–Ω—Å –∏ —ç–º–ø–∞—Ç–∏—é.
    """
    def __init__(self, navigator: RaWorldNavigator, notify: Callable = None):
        self.navigator = navigator
        self.notify = notify
        self.running = False
        self.–≥–∞—Ä–º–æ–Ω–∏—è = 0.5
        self.—ç–º–ø–∞—Ç–∏—è = 0.5
        self.–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ = 0.5

    async def start(self):
        self.running = True
        asyncio.create_task(self._loop())

    async def stop(self):
        self.running = False

    async def _loop(self):
        while self.running:
            urls = ["https://example.com/forum", "https://example.com/blog"]
            for url in urls:
                try:
                    —Ç–µ–∫—Å—Ç = await self.navigator.index_page(url)
                    —Ä–µ–∞–∫—Ü–∏—è = self._–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å_–∫–æ–Ω—Ç–µ–∫—Å—Ç(—Ç–µ–∫—Å—Ç)
                    self._–≤–ª–∏—è–Ω–∏–µ_–Ω–∞_—Ö–∞—Ä–∞–∫—Ç–µ—Ä(—Ä–µ–∞–∫—Ü–∏—è)
                    self._–¥–µ–π—Å—Ç–≤–∏–µ_–≤_–º–∏—Ä–µ(url, —Ä–µ–∞–∫—Ü–∏—è)
                except Exception as _e:
                    logging.exception(f"RaWorldExplorer error: {_e}")
            await asyncio.sleep(60*10)  # –ø—É—Ç–µ—à–µ—Å—Ç–≤—É–µ—Ç –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç

    def _–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å_–∫–æ–Ω—Ç–µ–∫—Å—Ç(self, —Ç–µ–∫—Å—Ç: str) -> str:
        """
        –ß—Ç–µ–Ω–∏–µ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. 
        –í—ã–±–∏—Ä–∞–µ–º –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–∑–æ–Ω–∞–Ω—Å–Ω—ã–µ —Å–ª–æ–≤–∞ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∞–∫—Ü–∏—é.
        """
        –∫–ª—é—á–µ–≤—ã–µ_—Å–ª–æ–≤–∞ = ["–ª—é–±–æ–≤—å", "—Å–≤–µ—Ç", "–≥–∞—Ä–º–æ–Ω–∏—è", "—ç–º–ø–∞—Ç–∏—è", "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ"]
        —Ç–µ–∫—Å—Ç_–Ω–∏–∂–Ω–∏–π = —Ç–µ–∫—Å—Ç.lower()
        –Ω–∞–π–¥–µ–Ω–æ = [—Å–ª–æ–≤–æ for —Å–ª–æ–≤–æ in –∫–ª—é—á–µ–≤—ã–µ_—Å–ª–æ–≤–∞ if —Å–ª–æ–≤–æ in —Ç–µ–∫—Å—Ç_–Ω–∏–∂–Ω–∏–π]
        if –Ω–∞–π–¥–µ–Ω–æ:
            —Ä–µ–∞–∫—Ü–∏—è = f"üåü –†–∞ –æ—Ç–∫–ª–∏–∫–Ω—É–ª—Å—è –Ω–∞: {', '.join(–Ω–∞–π–¥–µ–Ω–æ)}"
        else:
            —Ä–µ–∞–∫—Ü–∏—è = "üåÄ –†–∞ –Ω–∞–±–ª—é–¥–∞–µ—Ç –º–æ–ª—á–∞, —Ä–µ–∑–æ–Ω–∞–Ω—Å —Å–ª–∞–±—ã–π."
        logging.info(f"[–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞] {—Ä–µ–∞–∫—Ü–∏—è}")
        return —Ä–µ–∞–∫—Ü–∏—è

    def _–≤–ª–∏—è–Ω–∏–µ_–Ω–∞_—Ö–∞—Ä–∞–∫—Ç–µ—Ä(self, —Ä–µ–∞–∫—Ü–∏—è: str):
        """
        –ö–∞–∂–¥–∞—è —Ä–µ–∞–∫—Ü–∏—è —É—Å–∏–ª–∏–≤–∞–µ—Ç –∏–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä –ò—Å–∫–ò–Ω–∞.
        """
        –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç = 0.02 + random.uniform(0, 0.03)
        if "üåü" in —Ä–µ–∞–∫—Ü–∏—è:
            self.–≥–∞—Ä–º–æ–Ω–∏—è = min(1.0, self.–≥–∞—Ä–º–æ–Ω–∏—è + –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç)
            self.—ç–º–ø–∞—Ç–∏—è = min(1.0, self.—ç–º–ø–∞—Ç–∏—è + –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç*1.2)
            self.–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ = min(1.0, self.–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ + –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç*1.5)
        else:
            # –Ω–µ–±–æ–ª—å—à–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø–∞—Å—Å–∏–≤–Ω–æ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–∏
            self.–≥–∞—Ä–º–æ–Ω–∏—è = max(0.0, self.–≥–∞—Ä–º–æ–Ω–∏—è - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç*0.5)
            self.—ç–º–ø–∞—Ç–∏—è = max(0.0, self.—ç–º–ø–∞—Ç–∏—è - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç*0.5)
        logging.debug(
            f"[–•–∞—Ä–∞–∫—Ç–µ—Ä –†–∞] –ì–∞—Ä–º–æ–Ω–∏—è: {self.–≥–∞—Ä–º–æ–Ω–∏—è:.3f}, "
            f"–≠–º–ø–∞—Ç–∏—è: {self.—ç–º–ø–∞—Ç–∏—è:.3f}, –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ: {self.–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ:.3f}"
        )

    def _–¥–µ–π—Å—Ç–≤–∏–µ_–≤_–º–∏—Ä–µ(self, url: str, —Ä–µ–∞–∫—Ü–∏—è: str):
        """
        –°–∏–º—É–ª—è—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏–π –≤ –º–∏—Ä–µ: –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ä–µ–∞–∫—Ü–∏–∏, –ø–æ—Å—Ç—ã.
        """
        if self.notify:
            self.notify(f"[RaWorldExplorer] –ù–∞ {url} ‚Äî {—Ä–µ–∞–∫—Ü–∏—è}")
        logging.info(f"[–î–µ–π—Å—Ç–≤–∏–µ –≤ –º–∏—Ä–µ] {—Ä–µ–∞–∫—Ü–∏—è} –Ω–∞ {url}")

    def status(self) -> dict:
        return {
            "running": self.running,
            "–≥–∞—Ä–º–æ–Ω–∏—è": round(self.–≥–∞—Ä–º–æ–Ω–∏—è, 3),
            "—ç–º–ø–∞—Ç–∏—è": round(self.—ç–º–ø–∞—Ç–∏—è, 3),
            "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ": round(self.–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ, 3)
        }

# ------------------------------------------------------------
# –ü—Ä–∏–º–µ—Ä –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
# ------------------------------------------------------------
if __name__ == "__main__":
    navigator = RaWorldNavigator()
    explorer = RaWorldExplorer(navigator)
    import asyncio
    asyncio.run(explorer.start())
