<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Ra Nervous System</title>
  <style>
    body {
      background:#0b0f14;
      color:#9df;
      font-family:monospace;
      margin:20px;
    }
    h1 { color:#fff; }
    .event {
      border-bottom:1px solid #223;
      padding:4px;
      font-size:13px;
    }
    .ok { color:#7f7 }
    .warn { color:#ff7 }
    .err { color:#f77 }

    #pulse {
      font-size:22px;
      margin:10px 0;
      transition: opacity 0.3s;
    }

    #panel span {
      font-weight:bold;
    }

    .mood-—Å–ø–æ–∫–æ–π–Ω—ã–π { color:#7ff; }
    .mood-—Ç—Ä–µ–≤–æ–∂–Ω—ã–π { color:#f77; }
    .mood-—Ä–∞–¥–æ—Å—Ç–Ω—ã–π { color:#7f7; }
    .mood-–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ { color:#aaa; }

    select {
      background:#111;
      color:#9df;
      border:1px solid #333;
      padding:4px;
    }
  </style>
</head>
<body>

<h1>üúÇ Ra Nervous System Monitor</h1>

<div id="pulse">üíì</div>

<div id="panel">
  –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: <span id="mood" class="mood-–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ">‚Äî</span><br>
  –ù–∞–≥—Ä—É–∑–∫–∞: <span id="load">‚Äî</span><br>
  –°–æ–±—ã—Ç–∏–π/—Å–µ–∫: <span id="events_per_sec">‚Äî</span><br>
  –û—à–∏–±–∫–∏: <span id="errors">‚Äî</span><br>
  –ú—ã—Å–ª—å: <span id="thought">‚Äî</span>
</div>

<hr>

<div>
  –§–∏–ª—å—Ç—Ä —Å–æ–±—ã—Ç–∏–π:
  <select id="filter">
    <option value="">–í—Å–µ</option>
    <option value="world">–ú–∏—Ä</option>
    <option value="error">–û—à–∏–±–∫–∏</option>
    <option value="think">–ú—ã—Å–ª–∏</option>
  </select>
</div>

<hr>

<div id="events"></div>

<script>
const ws = new WebSocket("ws://localhost:8000/ws/events");

let eventCounter = 0;
let lastTick = Date.now();

// üíì –ü—É–ª—å—Å –†–∞
let pulseState = false;
setInterval(() => {
  const pulse = document.getElementById("pulse");
  pulseState = !pulseState;
  pulse.style.opacity = pulseState ? "1" : "0.3";
}, 500);

// üì° –ü—Ä–∏—ë–º —Å–æ–±—ã—Ç–∏–π
ws.onmessage = (e) => {
  eventCounter++;
  const data = JSON.parse(e.data);

  const filter = document.getElementById("filter").value;
  if (filter && !data.type.includes(filter)) return;

  const div = document.createElement("div");
  div.className = "event";

  let cls = "ok";
  if (data.type.includes("error")) cls = "err";
  if (data.type.includes("warn")) cls = "warn";

  div.classList.add(cls);
  div.innerText = `[${data.time}] ${data.source} ‚Üí ${data.type}: ${JSON.stringify(data.data)}`;
  document.getElementById("events").prepend(div);
};

// üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –†–∞
async function updateState() {
  try {
    const res = await fetch('/api/state');
    const data = await res.json();

    const moodEl = document.getElementById("mood");
    moodEl.innerText = data.mood || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
    moodEl.className = "mood-" + (data.mood || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ");

    document.getElementById("load").innerText = data.load;
    document.getElementById("errors").innerText = data.errors;
    document.getElementById("thought").innerText = data.last_thought;
  } catch(e) {
    console.warn("State fetch error:", e);
  }

  const now = Date.now();
  const diff = (now - lastTick) / 1000;
  document.getElementById("events_per_sec").innerText = (eventCounter / diff).toFixed(1);
  eventCounter = 0;
  lastTick = now;
}

setInterval(updateState, 1000);
</script>

</body>
</html>
