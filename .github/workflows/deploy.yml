name: üöÄ Deploy RaBot to Fly.io

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: üìÇ Checkout repository
        uses: actions/checkout@v4

      # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Flyctl
      - name: üîß Set up Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1
        with:
          version: '0.1.343'  # –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è

      # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
      - name: üîë Check Fly API token
        run: |
          if [ -z "${{ secrets.FLY_API_TOKEN }}" ]; then
            echo "‚ùå FLY_API_TOKEN is missing!"
            exit 1
          else
            echo "‚úÖ FLY_API_TOKEN is set"
          fi

      # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ fly.toml
      - name: üìù Check fly.toml
        run: |
          if [ ! -f ./fly.toml ]; then
            echo "‚ùå fly.toml not found in the root directory!"
            ls -la
            exit 1
          else
            echo "‚úÖ fly.toml found"
          fi

      # 5. –î–µ–ø–ª–æ–π –Ω–∞ Fly.io
      - name: üöÄ Deploy to Fly
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "Starting Fly.io deploy..."
          flyctl deploy --config ./fly.toml --app iskin-ra || {
            echo "‚ùå Deploy failed!"
            exit 1
          }
          echo "‚úÖ Deploy finished successfully!"
