name: üöÄ Deploy RaBot to Fly.io

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: üìÇ Checkout repository
        uses: actions/checkout@v4

      # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Flyctl
      - name: üîß Set up Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
      - name: üîë Check Fly API token
        run: |
          if [ -z "$FLY_API_TOKEN" ]; then
            echo "‚ùå FLY_API_TOKEN is missing!"
            exit 1
          fi
          echo "‚úÖ FLY_API_TOKEN is set"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ fly.toml
      - name: üìù Check fly.toml
        run: |
          CONFIG_PATH="${GITHUB_WORKSPACE}/fly.toml"
          if [ ! -f "$CONFIG_PATH" ]; then
            echo "‚ùå fly.toml not found in repo root!"
            ls -la $GITHUB_WORKSPACE
            exit 1
          fi
          echo "‚úÖ fly.toml found at $CONFIG_PATH"

      # 5. –î–µ–ø–ª–æ–π –Ω–∞ Fly.io
      - name: üöÄ Deploy to Fly
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          CONFIG_PATH="${GITHUB_WORKSPACE}/fly.toml"
          echo "Starting Fly.io deploy..."
          flyctl deploy --config "$CONFIG_PATH" --app iskin-ra
          echo "‚úÖ Deploy finished successfully!"
